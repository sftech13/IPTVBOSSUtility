name: Build IPTV Checker

on:
  push:
    tags:
      - "v*"

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    name: Build .deb on Ubuntu
    steps:
      - name: ✏️ Checkout Code
        uses: actions/checkout@v3

      - name: 🔧 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: ♻️ Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-tk python3-pip python3-venv patchelf
          pip install pyinstaller staticx

      - name: 💼 Build Debian Package
        run: |
          chmod +x build_deb.sh
          GITHUB_REF_NAME="${GITHUB_REF##*/}" ./build_deb.sh

      - name: 🔗 Upload .deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iptv-stream-checker-deb
          path: iptv_gui_v*.deb

  build-windows:
    runs-on: windows-latest
    name: Build .exe on Windows
    steps:
      - name: ✏️ Checkout Code
        uses: actions/checkout@v3

      - name: 🔧 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: ♻️ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: 💼 Build Windows Executable
        run: |
          pyinstaller --onefile --windowed iptv_gui_full.py

      - name: 🔗 Upload .exe Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iptv-stream-checker-exe
          path: dist/iptv_gui_full.exe

  docker-build:
    runs-on: ubuntu-latest
    name: Build Docker Image
    steps:
      - name: ✏️ Checkout Code
        uses: actions/checkout@v3

      - name: 🐳 Build Docker Image
        run: |
          docker build -t iptv-checker:latest .

      - name: 🚀 Create Docker Container
        run: docker create --name iptv-container iptv-checker:latest

      - name: 📤 Copy DEB from Container
        run: docker cp iptv-container:/app/iptv_gui_vdev.deb ./iptv_gui_vdev.deb

      - name: 🧹 Clean Up Container
        run: docker rm iptv-container

      - name: 🔗 Upload Docker .deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iptv-docker-deb
          path: iptv_gui_vdev.deb

  release:
    needs: [build-linux, build-windows, docker-build]
    runs-on: ubuntu-latest
    steps:
      - name: ✏️ Checkout Code
        uses: actions/checkout@v3

      - name: 🔗 Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: iptv-stream-checker-deb
          path: ./release

      - name: 🔗 Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: iptv-stream-checker-exe
          path: ./release

      - name: 🔗 Download Docker Artifact
        uses: actions/download-artifact@v4
        with:
          name: iptv-docker-deb
          path: ./release

      - name: 🎉 Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "IPTV Checker ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          files: |
            release/iptv_gui_v*.deb
            release/iptv_gui_full.exe
            release/iptv_gui_vdev.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
